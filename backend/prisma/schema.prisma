generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Accounting {
  id               String            @id @default(uuid())
  name             String
  cnpj             String            @unique
  email            String            @unique
  phone            String?
  address          String?
  logo_url         String?
  plan             String            @default("free")
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  chartOfAccounts  ChartOfAccounts[]
  clients          Client[]
  monthlyMovements MonthlyMovement[]
  supportTickets   SupportTicket[]
  users            User[]
  dreMappings      DREMapping[]
}

model User {
  id            String     @id @default(uuid())
  accounting_id String
  name          String
  email         String     @unique
  password_hash String
  role          String     @default("collaborator")
  status        String     @default("active")
  phone         String?
  avatar_url    String?
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  accounting    Accounting @relation(fields: [accounting_id], references: [id])

  @@index([accounting_id])
  @@index([email])
}

model Client {
  id                   String             @id @default(uuid())
  accounting_id        String
  name                 String
  cnpj                 String             @unique
  email                String?
  phone                String?
  industry             String?
  address              String?
  status               String             @default("active")
  password_hash        String?
  tax_regime           String?
  representative_email String?
  representative_name  String?
  created_at           DateTime           @default(now())
  updated_at           DateTime           @updatedAt
  entries              AccountingEntry[]
  periods              AccountingPeriod[]
  balanceSheets        BalanceSheet[]
  cashFlows            CashFlow[]
  chartOfAccounts      ChartOfAccounts[]
  accounting           Accounting         @relation(fields: [accounting_id], references: [id])
  incomeStatements     IncomeStatement[]
  monthlyMovements     MonthlyMovement[]
  supportTickets       SupportTicket[]
  dreMappings          DREMapping[]
}

model SupportTicket {
  id            String     @id @default(uuid())
  accounting_id String
  client_id     String
  subject       String
  message       String
  priority      String     @default("medium")
  status        String     @default("open")
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  closed_at     DateTime?
  accounting    Accounting @relation(fields: [accounting_id], references: [id])
  client        Client     @relation(fields: [client_id], references: [id])

  @@index([accounting_id])
  @@index([client_id])
  @@index([status])
}

model AccountingPeriod {
  id               String            @id @default(uuid())
  client_id        String
  year             Int
  month            Int
  start_date       DateTime
  end_date         DateTime
  is_closed        Boolean           @default(false)
  entries          AccountingEntry[]
  balanceSheets    BalanceSheet[]
  cashFlows        CashFlow[]
  incomeStatements IncomeStatement[]
  client           Client            @relation(fields: [client_id], references: [id])
}

model ChartOfAccounts {
  id              String                @id @default(uuid())
  client_id       String
  code            String
  name            String
  type            String                @default("A")
  parent_id       String?
  is_analytic     Boolean               @default(true)
  created_at      DateTime              @default(now())
  updated_at      DateTime              @updatedAt
  accounting_id   String?
  level           Int                   @default(1)
  alias           String?
  report_type     String?
  report_category String?
  is_mapped       Boolean               @default(false)
  items           AccountingEntryItem[]
  accounting      Accounting?           @relation(fields: [accounting_id], references: [id])
  client          Client                @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@unique([client_id, code])
  @@index([accounting_id])
  @@index([client_id])
  @@index([code])
}

model AccountingEntry {
  id              String                @id @default(uuid())
  client_id       String
  period_id       String
  date            DateTime
  description     String
  document_number String?
  total_value     Float
  created_by      String
  created_at      DateTime              @default(now())
  client          Client                @relation(fields: [client_id], references: [id])
  period          AccountingPeriod      @relation(fields: [period_id], references: [id])
  items           AccountingEntryItem[]
}

model AccountingEntryItem {
  id         String          @id @default(uuid())
  entry_id   String
  account_id String
  debit      Float
  credit     Float
  history    String?
  account    ChartOfAccounts @relation(fields: [account_id], references: [id])
  entry      AccountingEntry @relation(fields: [entry_id], references: [id])
}

model BalanceSheet {
  id                      String           @id @default(uuid())
  client_id               String
  period_id               String
  assets_current          Float
  assets_non_current      Float
  liabilities_current     Float
  liabilities_non_current Float
  equity                  Float
  calculated_at           DateTime         @default(now())
  client                  Client           @relation(fields: [client_id], references: [id])
  period                  AccountingPeriod @relation(fields: [period_id], references: [id])
}

model IncomeStatement {
  id                    String           @id @default(uuid())
  client_id             String
  period_id             String
  gross_revenue         Float
  deductions            Float
  net_revenue           Float
  cost_of_goods_sold    Float
  gross_profit          Float
  operating_expenses    Float
  operating_profit      Float
  financial_result      Float
  net_profit_before_tax Float
  taxes                 Float
  net_profit            Float
  calculated_at         DateTime         @default(now())
  client                Client           @relation(fields: [client_id], references: [id])
  period                AccountingPeriod @relation(fields: [period_id], references: [id])
}

model CashFlow {
  id                   String           @id @default(uuid())
  client_id            String
  period_id            String
  operating_activities Float
  investing_activities Float
  financing_activities Float
  net_cash_flow        Float
  opening_balance      Float
  closing_balance      Float
  calculated_at        DateTime         @default(now())
  client               Client           @relation(fields: [client_id], references: [id])
  period               AccountingPeriod @relation(fields: [period_id], references: [id])
}

model MonthlyMovement {
  id            String     @id @default(uuid())
  accounting_id String
  client_id     String
  year          Int
  code          String
  name          String
  level         Int        @default(1)
  values        Float[]
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  type          String     @default("dre")
  category      String?
  is_mapped     Boolean    @default(false)
  accounting    Accounting @relation(fields: [accounting_id], references: [id])
  client        Client     @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@unique([client_id, year, code, type])
  @@index([accounting_id])
  @@index([client_id])
  @@index([client_id, year])
  @@index([type])
  @@index([client_id, year, type])
}

model DREMapping {
  id            String     @id @default(uuid())
  accounting_id String
  client_id     String
  account_code  String
  account_name  String
  category      String
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  accounting    Accounting @relation(fields: [accounting_id], references: [id])
  client        Client     @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@unique([client_id, account_code], name: "client_id_account_code")
  @@index([accounting_id])
  @@index([client_id])
  @@index([category])
}
